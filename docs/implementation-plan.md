# こいこいルールエンジン 実装計画書

## 1. 概要

本ドキュメントは、`hanafuda-specification.md`（ゲームルール仕様書）と`implementation-specification.md`（技術仕様書）に基づき、C#によるこいこいルールエンジンの実装を段階的に進めるための具体的な計画書です。

## 2. 実装方針

### 2.1 基本方針
- **段階的な実装**: 各フェーズを順次完了させる
- **テスト駆動開発**: 各機能の実装前後にテストを作成・実行
- **最小単位での完成**: 各Issueは独立して完結する
- **並行開発可能**: フェーズ内の一部タスクは並行実行可能

### 2.2 実装の優先順位
実装仕様書の第15章に基づき、以下の4フェーズで実装を進めます：

1. **フェーズ1**: 基本機能（MVP）
2. **フェーズ2**: 完全なルール実装
3. **フェーズ3**: 拡張機能
4. **フェーズ4**: 高度な機能

## 3. プロジェクト構造の作成

### Issue #8: プロジェクト構造とソリューションのセットアップ

**優先度**: 最高  
**依存関係**: なし  
**推定工数**: 2-3時間

#### タスク内容
- [ ] .NET Coreソリューションファイルの作成
- [ ] 以下のプロジェクトを作成
  - `HanafudaEngine.Core` (クラスライブラリ)
  - `HanafudaEngine.Domain` (クラスライブラリ)
  - `HanafudaEngine.Facade` (クラスライブラリ)
  - `HanafudaEngine.Tests` (xUnitテストプロジェクト)
- [ ] プロジェクト間の参照関係を設定
- [ ] 基本的な名前空間構造を確立
- [ ] .gitignoreファイルの作成（bin/, obj/, .vs/など）
- [ ] READMEの更新（ビルド手順の追加）

#### 成果物
- `HanafudaEngine.sln`
- 各プロジェクトの`.csproj`ファイル
- 更新された`.gitignore`

---

## 4. フェーズ1: 基本機能（MVP）

### Issue #9: Core層の基本データモデル実装

**優先度**: 最高  
**依存関係**: Issue #8  
**推定工数**: 4-6時間

#### タスク内容
- [ ] `Month`列挙型の実装
- [ ] `CardType`列挙型の実装
- [ ] `SpecialCardFlag`列挙型の実装
- [ ] `Card`クラスの実装（等値比較含む）
- [ ] `PlayerId`列挙型の実装
- [ ] `YakuType`列挙型の実装
- [ ] `Yaku`クラスの実装
- [ ] 基本的なユニットテストの作成

#### 成果物
- `HanafudaEngine.Core/Models/`以下の全クラス
- 対応するユニットテスト

### Issue #10: 札の定義と管理

**優先度**: 最高  
**依存関係**: Issue #9  
**推定工数**: 6-8時間

#### タスク内容
- [ ] `CardDefinitions`クラスの実装
- [ ] 48枚の花札を定義（実装仕様書2.2に基づく）
- [ ] 月別、種類別の札取得メソッドの実装
- [ ] 特殊札フラグの設定（赤短、青短、盃、鹿、猪、蝶、雨札）
- [ ] 札定義の整合性テスト
  - 合計48枚の確認
  - 各月4枚の確認
  - 光札5枚、種札9枚、短冊札10枚、カス札24枚の確認

#### 成果物
- `HanafudaEngine.Core/Models/CardDefinitions.cs`
- 札定義の検証テスト

### Issue #11: ゲーム状態管理クラスの実装

**優先度**: 高  
**依存関係**: Issue #9  
**推定工数**: 6-8時間

#### タスク内容
- [ ] `GamePhase`列挙型の実装
- [ ] `TurnPhase`列挙型の実装
- [ ] `PlayerState`クラスの実装（不変性を保つWithメソッド含む）
- [ ] `GameState`クラスの実装（不変性を保つWithメソッド含む）
- [ ] `GameResult`クラスの実装
- [ ] 状態遷移のユニットテスト

#### 成果物
- `HanafudaEngine.Domain/`以下の状態管理クラス
- 状態遷移テスト

### Issue #12: 山札管理とシャッフル機能

**優先度**: 高  
**依存関係**: Issue #10  
**推定工数**: 3-4時間

#### タスク内容
- [ ] デッキのシャッフルロジック実装
- [ ] シード値指定によるテスト可能なシャッフル
- [ ] 配札ロジックの実装（親4枚→子4枚→場4枚→親4枚→子4枚→場4枚）
- [ ] 山札からのドロー機能
- [ ] シャッフルのテスト

#### 成果物
- 山札管理機能
- テスト用の固定デッキ機能

### Issue #13: 基本的な役判定の実装（光札、種、短冊、カス）

**優先度**: 高  
**依存関係**: Issue #10  
**推定工数**: 8-10時間

#### タスク内容
- [ ] `YakuEvaluator`クラスの基本構造
- [ ] 五光の判定ロジック
- [ ] 四光の判定ロジック
- [ ] 雨四光の判定ロジック
- [ ] 三光の判定ロジック
- [ ] 種（5枚以上）の判定ロジック
- [ ] 短冊（5枚以上）の判定ロジック
- [ ] カス（10枚以上）の判定ロジック
- [ ] 光札の役の排他性処理
- [ ] 各役の包括的なテスト

#### 成果物
- `HanafudaEngine.Domain/Services/YakuEvaluator.cs`
- 役判定の正常系・異常系テスト

### Issue #14: 得点計算機能の実装

**優先度**: 高  
**依存関係**: Issue #13  
**推定工数**: 4-5時間

#### タスク内容
- [ ] `ScoreCalculator`クラスの実装
- [ ] 基本得点の計算
- [ ] ボーナス得点の計算（種、短冊、カスの枚数超過分）
- [ ] こいこいボーナス（2倍）の処理
- [ ] こいこい失敗時の得点処理（0点）
- [ ] `CalculateFinalScore`メソッドの実装
- [ ] `CalculateGameResult`メソッドの実装
- [ ] 得点計算の各種パターンテスト

#### 成果物
- `HanafudaEngine.Domain/Services/ScoreCalculator.cs`
- 得点計算テスト

### Issue #15: ターン進行の基本ロジック

**優先度**: 高  
**依存関係**: Issue #11, #12  
**推定工数**: 8-10時間

#### タスク内容
- [ ] `TurnManager`クラスの実装
- [ ] ターンフェーズの遷移ロジック
  - PlayFromHand: 手札を出す
  - SelectFieldCard: 場札を選ぶ
  - DrawFromDeck: 山札を引く
  - SelectFieldCardForDraw: 引いた札で場札を選ぶ
  - YakuCheck: 役チェック
  - TurnEnd: ターン終了
- [ ] 札の取得ロジック
  - 同月札なし → 場に追加
  - 同月札1枚 → 自動取得
  - 同月札2枚以上 → 選択待ち
- [ ] プレイヤー交代処理
- [ ] ターン数のカウント
- [ ] ターン進行のテスト

#### 成果物
- `HanafudaEngine.Domain/Services/TurnManager.cs`
- ターン進行テスト

### Issue #16: アクション定義とバリデーション

**優先度**: 高  
**依存関係**: Issue #11  
**推定工数**: 6-8時間

#### タスク内容
- [ ] `IGameAction`インターフェースの定義
- [ ] `ActionType`列挙型の定義
- [ ] 各アクションクラスの実装
  - `PlayCardAction`
  - `SelectFieldCardAction`
  - `CallKoiKoiAction`
  - `CallShobuAction`
- [ ] `ActionValidator`クラスの実装
- [ ] `ValidationResult`クラスの実装
- [ ] 各アクションの妥当性検証ロジック
- [ ] バリデーションのテスト

#### 成果物
- `HanafudaEngine.Domain/Actions/`以下の全クラス
- `HanafudaEngine.Domain/Services/ActionValidator.cs`
- バリデーションテスト

### Issue #17: ゲームファサードの実装

**優先度**: 高  
**依存関係**: Issue #11, #15, #16  
**推定工数**: 8-10時間

#### タスク内容
- [ ] `KoiKoiGame`クラスの基本構造
- [ ] ゲーム初期化処理
- [ ] `GetState()`メソッドの実装
- [ ] `GetAvailableActions()`メソッドの実装
- [ ] `ExecuteAction()`メソッドの実装
- [ ] `GameActionResult`クラスの実装
- [ ] ゲームリセット機能
- [ ] 基本的なゲームフローの統合テスト

#### 成果物
- `HanafudaEngine.Facade/KoiKoiGame.cs`
- `HanafudaEngine.Facade/GameActionResult.cs`
- 統合テスト

### Issue #18: 配札検証と勝敗判定

**優先度**: 高  
**依存関係**: Issue #12, #17  
**推定工数**: 4-5時間

#### タスク内容
- [ ] `DealingValidator`クラスの実装
- [ ] 場に同月4枚の検証
- [ ] 再配札処理
- [ ] 勝敗判定ロジック
  - 役完成時に「勝負」を宣言した場合
  - 8ターン経過で総流れ（引き分け）
- [ ] 親の交代処理
- [ ] 勝敗判定のテスト

#### 成果物
- `HanafudaEngine.Domain/Services/DealingValidator.cs`
- 勝敗判定ロジック
- 配札・勝敗のテスト

### Issue #19: MVP統合テストとデバッグ

**優先度**: 高  
**依存関係**: Issue #18  
**推定工数**: 6-8時間

#### タスク内容
- [ ] 完全なゲームフローの統合テスト
  - ゲーム開始から終了まで
  - 正常系の動作確認
- [ ] 各種エッジケースのテスト
- [ ] パフォーマンステスト（基本的なもの）
- [ ] バグ修正
- [ ] ドキュメントの更新

#### 成果物
- 包括的な統合テスト
- 動作するMVP版ルールエンジン

---

## 5. フェーズ2: 完全なルール実装

### Issue #20: こいこいの宣言と処理

**優先度**: 高  
**依存関係**: Issue #19  
**推定工数**: 6-8時間

#### タスク内容
- [ ] こいこい/勝負の選択フェーズの実装
- [ ] `KoiKoiDecision`フェーズの状態管理
- [ ] こいこいフラグの管理
- [ ] こいこい宣言後のゲーム続行処理
- [ ] こいこい成功時の得点2倍処理
- [ ] こいこい失敗時の処理（相手の得点2倍）
- [ ] 双方がこいこいを宣言した場合の処理
- [ ] こいこいのテスト

#### 成果物
- こいこい機能の完全実装
- こいこいシナリオのテスト

### Issue #21: 喰い付き（くいつき）の実装

**優先度**: 高  
**依存関係**: Issue #19  
**推定工数**: 4-5時間

#### タスク内容
- [ ] `KuitsukiHandler`クラスの実装
- [ ] 喰い付き判定ロジック
  - 手札、場札、山札で同月3枚
- [ ] 喰い付き時の4枚取得処理
- [ ] 喰い付きのテスト

#### 成果物
- `HanafudaEngine.Domain/Services/KuitsukiHandler.cs`
- 喰い付きテスト

### Issue #22: 特殊な役の実装（猪鹿蝶、花見で一杯、月見で一杯）

**優先度**: 中  
**依存関係**: Issue #13  
**推定工数**: 4-5時間

#### タスク内容
- [ ] 猪鹿蝶の判定ロジック
  - 萩に猪、紅葉に鹿、牡丹に蝶の3枚
- [ ] 花見で一杯の判定ロジック
  - 桜に幕と菊に盃の2枚
- [ ] 月見で一杯の判定ロジック
  - 芒に月と菊に盃の2枚
- [ ] 特殊な種札の役と「種」の重複処理
- [ ] 特殊役のテスト

#### 成果物
- `YakuEvaluator`への追加実装
- 特殊役テスト

### Issue #23: 短冊の特殊役（赤短、青短）の実装

**優先度**: 中  
**依存関係**: Issue #13  
**推定工数**: 4-5時間

#### タスク内容
- [ ] 赤短の判定ロジック
  - 松・梅・桜の赤短3枚
- [ ] 青短の判定ロジック
  - 牡丹・菊・紅葉の青短3枚
- [ ] 赤短/青短と「短冊」の重複処理
- [ ] 特殊短冊役のテスト

#### 成果物
- `YakuEvaluator`への追加実装
- 特殊短冊役テスト

### Issue #24: 総流れ（そうながれ）の実装

**優先度**: 中  
**依存関係**: Issue #18  
**推定工数**: 3-4時間

#### タスク内容
- [ ] `DrawHandler`クラスの実装
- [ ] 8ターン経過の判定
- [ ] 総流れ時の処理
  - 引き分け判定
  - 親の続投
- [ ] 総流れのテスト

#### 成果物
- `HanafudaEngine.Domain/Services/DrawHandler.cs`
- 総流れテスト

### Issue #25: 配札の再検証機能

**優先度**: 中  
**依存関係**: Issue #18  
**推定工数**: 3-4時間

#### タスク内容
- [ ] 場に同月4枚の検証ロジックの強化
- [ ] 自動再配札処理の実装
- [ ] 再配札のテスト
- [ ] 再配札の回数制限（無限ループ防止）

#### 成果物
- 強化された配札検証
- 再配札テスト

### Issue #26: フェーズ2統合テストとデバッグ

**優先度**: 高  
**依存関係**: Issue #20-18  
**推定工数**: 6-8時間

#### タスク内容
- [ ] 完全ルールでの統合テスト
- [ ] 複雑なゲームシナリオのテスト
  - こいこいの連続
  - 喰い付きを含むゲーム
  - 総流れのケース
- [ ] バグ修正
- [ ] パフォーマンス検証
- [ ] ドキュメントの更新

#### 成果物
- 完全ルール実装版のルールエンジン
- 包括的な統合テスト

---

## 6. フェーズ3: 拡張機能

### Issue #27: 手四（てし）の実装（オプション）

**優先度**: 低  
**依存関係**: Issue #26  
**推定工数**: 4-5時間

#### タスク内容
- [ ] `TeshiHandler`クラスの実装
- [ ] 手四判定ロジック
  - 配られた手札に同月4枚
- [ ] 手四による即座の勝利処理
- [ ] 手四ルールの有効/無効切り替え
- [ ] 手四のテスト

#### 成果物
- `HanafudaEngine.Domain/Services/TeshiHandler.cs`
- 手四テスト

### Issue #28: ルール設定のカスタマイズ機能

**優先度**: 中  
**依存関係**: Issue #26  
**推定工数**: 5-6時間

#### タスク内容
- [ ] `GameRules`クラスの実装
- [ ] 各役の得点をカスタマイズ可能に
  - 五光、四光、雨四光、三光
  - 猪鹿蝶、花見で一杯、月見で一杯
  - 赤短、青短
- [ ] 特殊ルールの有効/無効切り替え
  - 手四の有効化
  - こいこいの倍率設定（2倍、3倍など）
  - 最大ターン数の設定
- [ ] デフォルトルールの定義
- [ ] カスタムルールのテスト

#### 成果物
- `HanafudaEngine.Domain/GameRules.cs`
- ルールカスタマイズテスト

### Issue #29: イベントシステムの実装

**優先度**: 中  
**依存関係**: Issue #17  
**推定工数**: 6-8時間

#### タスク内容
- [ ] `GameEvent`基底クラスの実装
- [ ] 各種イベントクラスの実装
  - `CardPlayedEvent`
  - `CardsCapturedEvent`
  - `YakuCompletedEvent`
  - `KoiKoiCalledEvent`
  - `GameEndedEvent`
- [ ] イベント発行機構
- [ ] イベントの収集と履歴管理
- [ ] イベントのテスト

#### 成果物
- `HanafudaEngine.Domain/Events/`以下の全クラス
- イベントシステムのテスト

### Issue #30: フェーズ3統合テストとデバッグ

**優先度**: 中  
**依存関係**: Issue #27-22  
**推定工数**: 4-5時間

#### タスク内容
- [ ] 拡張機能を含む統合テスト
- [ ] カスタムルールでのゲームテスト
- [ ] イベントシステムの動作確認
- [ ] バグ修正
- [ ] ドキュメントの更新

#### 成果物
- 拡張機能を含む完全版ルールエンジン
- 更新されたドキュメント

---

## 7. フェーズ4: 高度な機能

### Issue #31: パフォーマンス最適化

**優先度**: 低  
**依存関係**: Issue #30  
**推定工数**: 8-10時間

#### タスク内容
- [ ] パフォーマンスプロファイリング
- [ ] ボトルネックの特定
- [ ] 役判定の最適化
  - キャッシング機構の導入
  - LINQ vs ループの最適化
- [ ] 状態オブジェクトのメモリ最適化
- [ ] ベンチマークテストの作成
- [ ] 最適化効果の測定

#### 成果物
- 最適化されたルールエンジン
- パフォーマンステスト

### Issue #32: 詳細なログ機能

**優先度**: 低  
**依存関係**: Issue #29  
**推定工数**: 5-6時間

#### タスク内容
- [ ] ログフレームワークの統合（Serilogなど）
- [ ] 構造化ログの実装
- [ ] ログレベルの設定
  - デバッグ、情報、警告、エラー
- [ ] ゲームフローの詳細ログ
- [ ] デバッグ用のダンプ機能
- [ ] ログのテスト

#### 成果物
- 詳細なログ機能
- ログテスト

### Issue #33: リプレイ機能

**優先度**: 低  
**依存関係**: Issue #29  
**推定工数**: 8-10時間

#### タスク内容
- [ ] ゲーム履歴の記録
- [ ] ゲーム状態のスナップショット
- [ ] リプレイデータのシリアライゼーション
- [ ] リプレイの再生機能
- [ ] 早送り/巻き戻し機能
- [ ] リプレイのテスト

#### 成果物
- リプレイ機能
- リプレイテスト

### Issue #34: フェーズ4統合テストと最終調整

**優先度**: 低  
**依存関係**: Issue #31-26  
**推定工数**: 6-8時間

#### タスク内容
- [ ] 全機能を含む最終統合テスト
- [ ] パフォーマンステストの実施
- [ ] コードレビューと改善
- [ ] ドキュメントの最終更新
  - APIリファレンス
  - 使用例
  - パフォーマンス特性
- [ ] リリースノートの作成

#### 成果物
- 最終版ルールエンジン
- 完全なドキュメント

---

## 8. エラーハンドリングと例外設計

### Issue #35: エラーハンドリングの実装

**優先度**: 中  
**依存関係**: Issue #16  
**推定工数**: 4-5時間

#### タスク内容
- [ ] カスタム例外クラスの実装
  - `GameRuleViolationException`
  - `InvalidActionException`
  - `InvalidGameStateException`
- [ ] エラーハンドリング方針の実装
  - プログラミングエラー → 例外
  - ゲームルール違反 → 例外
  - ユーザー入力エラー → Resultパターン
- [ ] エラーメッセージの国際化対応（オプション）
- [ ] エラーハンドリングのテスト

#### 成果物
- カスタム例外クラス
- エラーハンドリングテスト

---

## 9. ドキュメンテーション

### Issue #36: APIリファレンスの作成

**優先度**: 中  
**依存関係**: Issue #26  
**推定工数**: 6-8時間

#### タスク内容
- [ ] XMLドキュメントコメントの追加
- [ ] DocFXまたはSandcastleを使用したAPIドキュメント生成
- [ ] サンプルコードの作成
- [ ] 使用例のドキュメント
- [ ] トラブルシューティングガイド

#### 成果物
- APIリファレンスドキュメント
- サンプルコード集

---

## 10. CI/CDパイプライン

### Issue #37: CI/CDの設定

**優先度**: 中  
**依存関係**: Issue #8  
**推定工数**: 4-5時間

#### タスク内容
- [ ] GitHub Actionsワークフローの作成
- [ ] ビルドパイプラインの設定
- [ ] テスト自動実行の設定
- [ ] コードカバレッジの測定
- [ ] 静的解析ツールの統合
- [ ] 自動リリースフローの設定

#### 成果物
- `.github/workflows/`以下の設定ファイル
- 自動化されたCI/CDパイプライン

---

## 11. 実装スケジュール（推定）

### 全体工数
- **フェーズ1**: 約60-75時間（2-3週間）
- **フェーズ2**: 約30-40時間（1-2週間）
- **フェーズ3**: 約15-20時間（1週間）
- **フェーズ4**: 約20-25時間（1週間）
- **その他（ドキュメント、CI/CD等）**: 約15-20時間（1週間）

**合計**: 約140-180時間（6-8週間）

### マイルストーン
1. **M1: MVP完成** - フェーズ1完了時
2. **M2: 完全ルール実装** - フェーズ2完了時
3. **M3: 拡張機能実装** - フェーズ3完了時
4. **M4: リリース準備完了** - フェーズ4完了時

---

## 12. 並行実装可能なタスク

以下のIssueは依存関係が少なく、並行して実装可能です：

### フェーズ1内の並行可能タスク
- Issue #9（データモデル）とIssue #11（状態管理）は並行可能
- Issue #13（役判定）とIssue #15（ターン進行）は部分的に並行可能

### フェーズ2内の並行可能タスク
- Issue #21（喰い付き）、#22（特殊役：種）、#23（特殊役：短冊）は並行可能
- Issue #24（総流れ）とIssue #25（配札再検証）は並行可能

### フェーズ3内の並行可能タスク
- Issue #27（手四）、#28（ルール設定）、#29（イベント）は並行可能

### その他
- Issue #35（エラーハンドリング）は各フェーズと並行実装可能
- Issue #37（CI/CD）はプロジェクト初期から並行実装可能

---

## 13. リスクと対策

### 技術的リスク

#### リスク1: 不変性を保つ設計の複雑さ
**対策**: 
- Withメソッドパターンの徹底
- レコード型（C# 9.0以降）の活用検討
- 十分なユニットテストでの検証

#### リスク2: パフォーマンス問題
**対策**:
- 早期のパフォーマンステスト実施
- プロファイリングツールの活用
- 必要に応じて構造体の使用

#### リスク3: 役判定の複雑さ
**対策**:
- テストケースの充実
- 段階的な実装とテスト
- ペアプログラミングでのレビュー

### プロジェクト管理リスク

#### リスク1: スコープクリープ
**対策**:
- 各フェーズの完了基準を明確に
- 拡張機能は後回し
- MVPの早期完成を優先

#### リスク2: 工数オーバー
**対策**:
- バッファを含めた見積もり
- 定期的な進捗確認
- 優先順位の見直し

---

## 14. 品質基準

### コードカバレッジ
- **最低基準**: 70%
- **目標**: 85%以上
- **重要なロジック**: 95%以上（役判定、得点計算など）

### コーディング規約
- C#コーディング規約に準拠
- StyleCop/Analyzerによる静的解析
- 命名規則は実装仕様書付録Bに従う

### テスト基準
- 各機能に対してユニットテストを作成
- 重要な機能には統合テストを作成
- 境界値テストとエッジケーステストの実施

---

## 15. 完了条件

### フェーズ1完了条件
- [ ] 基本的なゲームフローが動作する
- [ ] 手札を出して札を取得できる
- [ ] 基本的な役判定が機能する
- [ ] 得点計算が正確
- [ ] 勝敗判定が正しい
- [ ] テストカバレッジ70%以上

### フェーズ2完了条件
- [ ] こいこい機能が完全動作
- [ ] 喰い付きが正しく処理される
- [ ] 全ての役が判定される
- [ ] 総流れが正しく処理される
- [ ] テストカバレッジ80%以上

### フェーズ3完了条件
- [ ] 手四がオプションとして動作
- [ ] ルール設定がカスタマイズ可能
- [ ] イベントシステムが機能
- [ ] テストカバレッジ85%以上

### フェーズ4完了条件
- [ ] パフォーマンスが基準を満たす
- [ ] ログ機能が充実
- [ ] リプレイ機能が動作
- [ ] 完全なドキュメントが整備
- [ ] テストカバレッジ85%以上

---

## 16. 次のアクション

### 即座に実行すべきこと
1. **Issue #8**: プロジェクト構造のセットアップ（最優先）
2. **Issue #37**: CI/CDパイプラインの基本設定（並行実行）
3. **Issue #9**: Core層のデータモデル実装（次の優先）

### 開発開始前の準備
- [ ] 開発環境のセットアップ（.NET SDK、IDE）
- [ ] Gitブランチ戦略の決定
- [ ] コードレビュープロセスの確立
- [ ] Issue管理方法の確認

---

## 17. まとめ

本実装計画書では、こいこいルールエンジンを30のIssueに分解し、4つのフェーズで段階的に実装する計画を示しました。各Issueは独立して完結し、並行開発も可能な設計となっています。

次のステップとして、各IssueをGitHubのIssueとして登録し、このメインIssueにSub Issueとして関連付けることで、実装の進捗を可視化し、効率的に開発を進めることができます。

---

**作成日**: 2025-11-17  
**バージョン**: 1.0  
**作成者**: GitHub Copilot
